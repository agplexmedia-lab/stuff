<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AG Plex ‚Äî Plexdle</title>

  <!-- Favicon -->
  <link rel="apple-touch-icon" href="../assets/favicon-180.png">
  <link rel="icon" type="image/png" href="../assets/favicon-180.png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --site-blue:#1f78c8;
      --panel-bg:#dff0ff;
      --page-bg:#f3f6fb;
      --card-bg:#ffffff;
      --text:#1f2937;
      --muted:#334155;
      --link:#1f78c8;
      --shadow:0 10px 25px rgba(15, 23, 42, 0.12);
      --shadow-soft:0 6px 18px rgba(15, 23, 42, 0.10);
      --radius-xl:26px;

      /* universal header accent */
      --aqua:#28f2ff;

      /* ===== GLOBAL BANNER OFFSET (JS sets dynamically) ===== */
      --banner-offset: 0px;

      /* game colors */
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#eef2ff;
      --chip-text:#1e293b;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:'Poppins',sans-serif;
      background: var(--page-bg);
      color: var(--text);
      text-align:center;

      padding-left: 18px;
      padding-right: 18px;
      padding-bottom: 0;

      padding-top: var(--banner-offset);
    }

    /* ===== GLOBAL BANNER (fixed + safe header offset) ===== */
    .global-banner{
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 9999;
      width: 100%;
      background: #f59e0b;
      color: #111827;
      padding: 10px 14px;
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      line-height: 1.25;
    }
    .global-banner a{
      color:#111827;
      text-decoration:underline;
      font-weight: 900;
    }

    .site-header{ top: var(--banner-offset); }

    /* =========================
       UNIVERSAL HEADER
    ========================== */
    .site-header{
      position: sticky;
      z-index: 100;
      padding: calc(14px + env(safe-area-inset-top)) 14px 12px;
      display:flex;
      justify-content:center;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,0));
      backdrop-filter: blur(6px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 8px 18px;
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.10);
      text-decoration:none;
      color:#111827;
      font-weight:900;
      letter-spacing:1px;
      position:relative;
      overflow:hidden;
    }
    .brand img{
      width:32px;
      height:32px;
      object-fit:contain;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }
    .brand::after{
      content:"";
      position:absolute;
      left:18px; right:18px;
      bottom:6px;
      height:3px;
      background: linear-gradient(90deg, transparent, var(--aqua), transparent);
      transform: scaleX(0);
      transition: transform .35s ease;
      border-radius:999px;
    }
    .brand:hover::after,
    .brand:focus-visible::after{ transform: scaleX(1); }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 0 0 30px;
    }

    .hero{
      margin: 18px auto 0;
      background: var(--panel-bg);
      border-radius: var(--radius-xl);
      padding: 30px 18px 22px;
      box-shadow: var(--shadow-soft);
    }

    h1{
      margin: 0 0 10px;
      font-size: clamp(30px, 4vw, 44px);
      color: var(--site-blue);
      letter-spacing: -0.5px;
    }

    .subtext{
      margin: 0 auto;
      max-width: 780px;
      font-size: 15px;
      line-height: 1.55;
      color: #111827;
    }

    .chips{
      margin: 14px auto 0;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
    }
    .chip{
      background: var(--chip);
      color: var(--chip-text);
      border: 1px solid rgba(30,41,59,.12);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .2px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      display:inline-block;
      background:#94a3b8;
    }
    .dot.good{ background: var(--good); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--bad); }

    .card{
      max-width: 820px;
      margin: 22px auto 0;
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 22px;
      box-shadow: var(--shadow);
      text-align:left;
    }

    .toprow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }

    .status{
      font-weight:800;
      color:#0f172a;
      font-size: 14px;
    }
    .status small{ font-weight:700; color: var(--muted); }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: var(--site-blue);
      color: white;
      font-weight: 800;
      cursor:pointer;
      text-decoration:none;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
    }
    .btn:hover{ filter: brightness(0.95); }

    .btn-ghost{
      background: #e5e7eb;
      color:#111827;
    }
    .btn[disabled]{
      background:#9ca3af;
      cursor:not-allowed;
      filter:none;
    }

    .inputrow{
      display:flex;
      gap:10px;
      margin-top: 10px;
      flex-wrap:wrap;
      align-items:stretch;
    }

    input{
      flex: 1 1 320px;
      width:100%;
      padding: 14px 14px;
      border: 1px solid #d1d5db;
      border-radius: 14px;
      font-size: 16px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus{
      outline:none;
      border-color: var(--site-blue);
      box-shadow: 0 0 0 4px rgba(31,120,200,0.18);
    }

    .help{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .msg{
      margin-top: 10px;
      font-size: 14px;
      font-weight: 800;
      color: #0f172a;
    }
    .msg.bad{ color: #991b1b; }
    .msg.good{ color: #14532d; }

    /* Daily freebie hint box */
    .freebie{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      background: #eef2ff;
      border: 1px solid rgba(30,41,59,.10);
      color:#0f172a;
      font-weight: 900;
      display:none;
      line-height: 1.35;
    }
    .freebie .label{
      display:inline-block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .7px;
      color: var(--muted);
      margin-right: 8px;
      font-weight: 900;
    }
    .freebie .value{
      font-weight: 900;
    }

    .board{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{
      display:grid;
      grid-template-columns: 1.6fr 0.7fr 0.9fr 0.9fr 0.7fr;
      gap:10px;
      align-items:stretch;
    }

    .cell{
      background:#f4f6f9;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 10px 12px;
      min-height: 46px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight: 900;
      color:#0f172a;
    }

    .titlecell{
      justify-content:flex-start;
      text-align:left;
      font-weight: 900;
      overflow:hidden;
    }
    .titlecell span{
      display:-webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow:hidden;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(15,23,42,.10);
      background: white;
      font-weight: 900;
      width:100%;
      min-height: 30px;

      /* allow long values like genres/studios to not explode layout */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pill.good{ background: rgba(22,163,74,.12); color:#14532d; border-color: rgba(22,163,74,.25); }
    .pill.warn{ background: rgba(245,158,11,.14); color:#7c2d12; border-color: rgba(245,158,11,.28); }
    .pill.bad{  background: rgba(239,68,68,.12); color:#7f1d1d; border-color: rgba(239,68,68,.25); }

    .headerrow{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1.6fr 0.7fr 0.9fr 0.9fr 0.7fr;
      gap:10px;
    }
    .colhead{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .6px;
      padding: 0 6px;
      text-align:center;
    }
    .colhead:first-child{ text-align:left; }

    .reveal{
      margin-top: 14px;
      padding: 14px 14px;
      border-radius: 16px;
      background: #eef2ff;
      border: 1px solid rgba(30,41,59,.10);
      color:#0f172a;
      font-weight: 800;
      display:none;
    }
    .reveal a{
      color: var(--link);
      font-weight: 900;
      text-decoration: underline;
    }

    @media (max-width: 720px){
      body{ padding-left:14px; padding-right:14px; }
      .card{ padding: 18px; }
      .hero{ padding: 22px 14px 16px; margin-top: 10px; }

      .site-header{
        padding: calc(6px + env(safe-area-inset-top)) 10px 6px;
      }

      .row, .headerrow{
        grid-template-columns: 1.7fr 0.8fr 1fr 1fr 0.8fr;
        gap:8px;
      }
      .cell{ border-radius: 12px; padding: 10px 10px; }
      .pill{ font-size: 12px; }
    }
  </style>
</head>

<body>

  <!-- UNIVERSAL HEADER -->
  <header class="site-header">
    <a href="https://agplexmedia-lab.github.io/stuff/home/" class="brand">
      <img src="../assets/favicon-180.png" alt="AG Plex Home">
      <span>AG PLEX</span>
    </a>
  </header>

  <div class="wrap">

    <div class="hero">
      <h1>Plexdle</h1>
      <div class="subtext">
        Daily movie guessing game ‚Äî you get <strong>6 guesses</strong>.<br>
        Type a title and hit Guess. (If a title exists multiple times, it‚Äôll ask for the year.)
      </div>

      <div class="chips" aria-hidden="true">
        <span class="chip"><span class="dot good"></span> Match shows the value</span>
        <span class="chip"><span class="dot warn"></span> Higher / lower hint</span>
        <span class="chip"><span class="dot bad"></span> No match</span>
      </div>
    </div>

    <div class="card">
      <div class="toprow">
        <div class="status" id="statusLine">Loading‚Ä¶</div>
        <div class="controls">
          <button class="btn btn-ghost" id="howBtn" type="button">How it works</button>
          <button class="btn btn-ghost" id="resetBtn" type="button">Reset today</button>
        </div>
      </div>

      <!-- Daily pre-revealed hint -->
      <div class="freebie" id="freebieBox">
        <span class="label">Today‚Äôs freebie:</span>
        <span class="value" id="freebieValue"></span>
      </div>

      <div class="inputrow">
        <input id="guessInput" list="titleList" placeholder="Type a movie title‚Ä¶" autocomplete="off" />
        <datalist id="titleList"></datalist>
        <button class="btn" id="guessBtn" type="button">Guess</button>
      </div>

      <div class="help" id="helpBox" style="display:none;">
        <strong>Hints:</strong><br>
        <strong>Year:</strong> ‚¨ÜÔ∏è means the answer‚Äôs year is higher, ‚¨áÔ∏è means lower. If you match it, it shows the exact year.<br>
        <strong>Runtime:</strong> ‚¨ÜÔ∏è means the answer is longer, ‚¨áÔ∏è means shorter (shows minute difference). If you match it, it shows exact minutes.<br>
        <strong>Genres:</strong> shows how many genres overlap (e.g. 1/2). If you match all genres, it shows the full genre list.<br>
        <strong>Rating:</strong> if you match it, it shows the actual rating (PG-13, R, etc.).
      </div>

      <div class="msg" id="msg"></div>

      <div class="headerrow" aria-hidden="true">
        <div class="colhead">Title</div>
        <div class="colhead">Year</div>
        <div class="colhead">Runtime</div>
        <div class="colhead">Genres</div>
        <div class="colhead">Rating</div>
      </div>

      <div class="board" id="board"></div>

      <!-- Answer reveal (always shown when win/lose) -->
      <div class="reveal" id="revealBox"></div>
    </div>

    <!-- UNIVERSAL FOOTER MOUNT -->
    <div id="footerMount"></div>

  </div>

  <!-- ===== GLOBAL BANNER LOADER ===== -->
  <script>
  (async () => {
    try {
      if (document.body.dataset.noBanner === "true") return;

      const cfgRes = await fetch("/stuff/assets/banner-config.json", { cache: "no-store" });
      if (!cfgRes.ok) return;
      const cfg = await cfgRes.json();
      if (!cfg.enabled) return;

      const htmlPath = cfg.html_path || "/stuff/assets/banner.html";
      const bannerRes = await fetch(htmlPath, { cache: "no-store" });
      if (!bannerRes.ok) return;

      const html = await bannerRes.text();
      const mount = document.createElement("div");
      mount.innerHTML = html;

      document.body.insertBefore(mount, document.body.firstChild);

      function setOffset(){
        const bannerEl = document.querySelector(".global-banner");
        const h = bannerEl ? Math.ceil(bannerEl.getBoundingClientRect().height) : 0;
        document.documentElement.style.setProperty("--banner-offset", h + "px");
      }

      setOffset();
      window.addEventListener("resize", setOffset);
    } catch {
      // fail silently
    }
  })();
  </script>

  <!-- ===== GLOBAL FOOTER LOADER ===== -->
  <script>
  (async () => {
    try {
      if (document.body.dataset.noFooter === "true") return;

      const cfgRes = await fetch("/stuff/assets/footer-config.json", { cache: "no-store" });
      if (!cfgRes.ok) return;
      const cfg = await cfgRes.json();
      if (!cfg.enabled) return;

      const htmlPath = cfg.html_path || "/stuff/assets/footer.html";
      const footerRes = await fetch(htmlPath, { cache: "no-store" });
      if (!footerRes.ok) return;

      const html = await footerRes.text();
      const mount = document.getElementById("footerMount") || document.body;

      const wrap = document.createElement("div");
      wrap.innerHTML = html;

      if (mount === document.body) document.body.appendChild(wrap);
      else mount.replaceChildren(wrap);
    } catch {
      // fail silently
    }
  })();
  </script>

  <script>
    /************************************************************
     * ANDREW: CONFIG
     ************************************************************/
    const MOVIES_URL = "https://apag104.github.io/ag-json/recently_added_movies.json";
    const MAX_GUESSES = 6;

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function normTitle(s){
      return (s || "").toLowerCase().trim().replace(/\s+/g, " ");
    }

    function splitGenres(str){
      return (str || "")
        .split(",")
        .map(s => s.trim().toLowerCase())
        .filter(Boolean);
    }

    function dailyIndex(len){
      const day = Math.floor(Date.now() / 86400000);
      return len ? (day % len) : 0;
    }

    function dailyFreebieKey(){
      // rotates: year -> runtime -> genres -> rating
      const keys = ["year", "runtime", "genres", "rating"];
      const day = Math.floor(Date.now() / 86400000);
      return keys[day % keys.length];
    }

    // UI refs
    const statusLine = document.getElementById("statusLine");
    const guessInput  = document.getElementById("guessInput");
    const titleList   = document.getElementById("titleList");
    const guessBtn    = document.getElementById("guessBtn");
    const resetBtn    = document.getElementById("resetBtn");
    const howBtn      = document.getElementById("howBtn");
    const helpBox     = document.getElementById("helpBox");
    const msg         = document.getElementById("msg");
    const board       = document.getElementById("board");
    const revealBox   = document.getElementById("revealBox");
    const freebieBox  = document.getElementById("freebieBox");
    const freebieValue= document.getElementById("freebieValue");

    // Game state
    let MOVIES = [];
    let TITLE_TO_MOVIES = new Map();
    let ANSWER = null;
    let FREEBIE = null; // one of: year/runtime/genres/rating
    let STATE = { day: todayKey(), guesses: [], done: false };

    const STORAGE_KEY = "agplex_plexdle_state_v2";

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (!s || typeof s !== "object") return;
        if (s.day !== todayKey()) return;
        if (!Array.isArray(s.guesses)) s.guesses = [];
        STATE = {
          day: s.day,
          guesses: s.guesses.slice(0, MAX_GUESSES),
          done: !!s.done
        };
      }catch{}
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
      }catch{}
    }

    function setMessage(text, kind=""){
      msg.className = "msg" + (kind ? " " + kind : "");
      msg.textContent = text || "";
    }

    function imdbLink(imdbId){
      if (!imdbId) return "";
      return `https://www.imdb.com/title/${imdbId}/`;
    }

    function makePill(text, tone){
      const span = document.createElement("div");
      span.className = `pill ${tone || ""}`.trim();
      span.title = text; // lets you long-press / hover to see full value
      span.textContent = text;
      return span;
    }

    function renderRow(guess, feedback){
      const row = document.createElement("div");
      row.className = "row";

      const titleCell = document.createElement("div");
      titleCell.className = "cell titlecell";
      const titleSpan = document.createElement("span");
      titleSpan.textContent = `${guess.title} (${guess.year})`;
      titleCell.appendChild(titleSpan);

      const yearCell = document.createElement("div");
      yearCell.className = "cell";
      yearCell.appendChild(makePill(feedback.year.text, feedback.year.tone));

      const rtCell = document.createElement("div");
      rtCell.className = "cell";
      rtCell.appendChild(makePill(feedback.runtime.text, feedback.runtime.tone));

      const gCell = document.createElement("div");
      gCell.className = "cell";
      gCell.appendChild(makePill(feedback.genres.text, feedback.genres.tone));

      const rCell = document.createElement("div");
      rCell.className = "cell";
      rCell.appendChild(makePill(feedback.rating.text, feedback.rating.tone));

      row.appendChild(titleCell);
      row.appendChild(yearCell);
      row.appendChild(rtCell);
      row.appendChild(gCell);
      row.appendChild(rCell);

      board.prepend(row);
    }

    function compareGuess(guess, answer){
      // YEAR: if matched, show actual year
      let yearTone = "bad";
      let yearText = "‚Äî";
      if (Number(guess.year) === Number(answer.year)){
        yearTone = "good";
        yearText = `${answer.year}`;
      } else if (Number(guess.year) < Number(answer.year)){
        yearTone = "warn";
        yearText = "‚¨ÜÔ∏è";
      } else {
        yearTone = "warn";
        yearText = "‚¨áÔ∏è";
      }

      // RUNTIME: if matched, show actual minutes
      const gRT = Number(guess.runtime_minutes || 0);
      const aRT = Number(answer.runtime_minutes || 0);
      let rtTone = "bad";
      let rtText = "n/a";
      if (gRT && aRT){
        if (gRT === aRT){
          rtTone = "good";
          rtText = `${aRT}m`;
        } else if (gRT < aRT){
          rtTone = "warn";
          rtText = `‚¨ÜÔ∏è +${aRT - gRT}m`;
        } else {
          rtTone = "warn";
          rtText = `‚¨áÔ∏è -${gRT - aRT}m`;
        }
      }

      // GENRES: if perfect match, show full genres string
      const gGenres = new Set(splitGenres(guess.genres));
      const aGenresList = splitGenres(answer.genres);
      const aSet = new Set(aGenresList);
      let match = 0;
      for (const g of gGenres) if (aSet.has(g)) match++;
      const denom = aGenresList.length || 0;

      let genTone = "bad";
      let genText = denom ? `${match}/${denom}` : "n/a";
      if (denom > 0 && match === denom){
        genTone = "good";
        genText = (answer.genres || "").toString().trim() || "‚úÖ";
      } else if (match > 0){
        genTone = "warn";
      }

      // RATING: if matched, show actual rating
      const gr = (guess.content_rating || "").toString().trim().toLowerCase();
      const ar = (answer.content_rating || "").toString().trim().toLowerCase();
      let ratTone = "bad";
      let ratText = "n/a";
      if (ar){
        if (gr && gr === ar){
          ratTone = "good";
          ratText = (answer.content_rating || "").toString().trim();
        } else if (gr && gr !== ar){
          ratTone = "bad";
          ratText = "‚úñ";
        } else {
          ratTone = "bad";
          ratText = "‚Äî";
        }
      }

      const correct = (normTitle(guess.title) === normTitle(answer.title) && Number(guess.year) === Number(answer.year));

      return {
        correct,
        year: { text: yearText, tone: yearTone },
        runtime: { text: rtText, tone: rtTone },
        genres: { text: genText, tone: genTone },
        rating: { text: ratText, tone: ratTone }
      };
    }

    function showFreebie(){
      if (!ANSWER || !FREEBIE) return;

      let label = "";
      let value = "";

      if (FREEBIE === "year"){
        label = "Year";
        value = `${ANSWER.year}`;
      } else if (FREEBIE === "runtime"){
        label = "Runtime";
        value = ANSWER.runtime_minutes ? `${ANSWER.runtime_minutes} minutes` : "n/a";
      } else if (FREEBIE === "genres"){
        label = "Genres";
        value = (ANSWER.genres || "").toString().trim() || "n/a";
      } else if (FREEBIE === "rating"){
        label = "Rating";
        value = (ANSWER.content_rating || "").toString().trim() || "n/a";
      }

      freebieValue.textContent = `${label}: ${value}`;
      freebieBox.style.display = "block";
    }

    function showReveal(win){
      const a = ANSWER;
      const link = imdbLink(a.imdb_id);
      const title = `${a.title} (${a.year})`;
      const rt = a.runtime_minutes ? `${a.runtime_minutes} min` : "n/a";
      const genres = a.genres ? a.genres : "n/a";
      const rating = a.content_rating ? a.content_rating : "n/a";

      let html = `<div>${win ? "üéâ" : "üòµ"} <strong>Answer:</strong> ${title}</div>`;
      html += `<div style="margin-top:8px; font-weight:900;">Year: ${a.year} ¬∑ Runtime: ${rt} ¬∑ Genres: ${genres} ¬∑ Rating: ${rating}</div>`;
      if (a.plot){
        html += `<div style="margin-top:10px; font-weight:700; color:#334155; line-height:1.45;">${a.plot}</div>`;
      }
      if (link){
        html += `<div style="margin-top:10px;"><a href="${link}" target="_blank" rel="noopener">Open on IMDb</a></div>`;
      }

      revealBox.innerHTML = html;
      revealBox.style.display = "block";
    }

    function setLocked(locked){
      guessBtn.disabled = locked;
      guessInput.disabled = locked;
    }

    function updateStatus(){
      const used = STATE.guesses.length;
      const left = Math.max(0, MAX_GUESSES - used);
      statusLine.innerHTML = `Guesses: <strong>${used}/${MAX_GUESSES}</strong> <small>(left: ${left})</small>`;
    }

    function buildTitleIndex(){
      TITLE_TO_MOVIES.clear();

      for (const m of MOVIES){
        const key = normTitle(m.title);
        if (!TITLE_TO_MOVIES.has(key)) TITLE_TO_MOVIES.set(key, []);
        TITLE_TO_MOVIES.get(key).push(m);
      }

      const uniqueTitles = Array.from(TITLE_TO_MOVIES.keys())
        .map(k => TITLE_TO_MOVIES.get(k)[0].title)
        .sort((a,b) => a.localeCompare(b));

      titleList.innerHTML = uniqueTitles.map(t => `<option value="${t}"></option>`).join("");
    }

    function findByUserInput(raw){
      const input = raw.trim();
      if (!input) return { movie: null, error: "Type a title." };

      // If user includes "(YEAR)" we honor that
      const m = input.match(/^(.*?)(?:\s*\(\s*(\d{4})\s*\))\s*$/);
      if (m){
        const t = normTitle(m[1]);
        const y = Number(m[2]);
        const list = TITLE_TO_MOVIES.get(t) || [];
        const exact = list.find(x => Number(x.year) === y);
        if (!exact) return { movie: null, error: "That title/year combo isn‚Äôt in AG Plex." };
        return { movie: exact, error: "" };
      }

      // Title-only match
      const key = normTitle(input);
      const list = TITLE_TO_MOVIES.get(key) || [];

      if (list.length === 0){
        return { movie: null, error: "Not found in AG Plex. Pick from the suggestions." };
      }
      if (list.length > 1){
        const years = list
          .map(x => x.year)
          .filter(Boolean)
          .sort((a,b) => a-b)
          .join(", ");
        return { movie: null, error: `Multiple movies named "${input}". Type: ${list[0].title} (YEAR). Years: ${years}` };
      }

      return { movie: list[0], error: "" };
    }

    function alreadyGuessed(movie){
      return STATE.guesses.some(g =>
        normTitle(g.title) === normTitle(movie.title) && Number(g.year) === Number(movie.year)
      );
    }

    function handleGuess(){
      if (!ANSWER) return;

      setMessage("");

      const raw = guessInput.value;
      const { movie, error } = findByUserInput(raw);

      if (!movie){
        setMessage(error, "bad");
        return;
      }

      if (alreadyGuessed(movie)){
        setMessage("You already guessed that one.", "bad");
        return;
      }

      if (STATE.done){
        setMessage("Today‚Äôs game is already finished.", "bad");
        return;
      }

      const g = {
        title: movie.title,
        year: movie.year,
        genres: movie.genres || "",
        runtime_minutes: Number(movie.runtime_minutes || 0),
        content_rating: movie.content_rating || ""
      };
      STATE.guesses.push(g);

      const fb = compareGuess(g, ANSWER);
      renderRow(g, fb);

      guessInput.value = "";
      guessInput.focus();

      if (fb.correct){
        STATE.done = true;
        saveState();
        updateStatus();
        setLocked(true);
        setMessage(`You got it in ${STATE.guesses.length}/${MAX_GUESSES}.`, "good");
        showReveal(true); // ‚úÖ answer reveal at end (win)
        return;
      }

      if (STATE.guesses.length >= MAX_GUESSES){
        STATE.done = true;
        saveState();
        updateStatus();
        setLocked(true);
        setMessage(`Out of guesses.`, "bad");
        showReveal(false); // ‚úÖ answer reveal at end (lose)
        return;
      }

      saveState();
      updateStatus();
    }

    function resetToday(){
      STATE = { day: todayKey(), guesses: [], done: false };
      saveState();
      board.innerHTML = "";
      revealBox.style.display = "none";
      revealBox.innerHTML = "";
      setMessage("");
      setLocked(false);
      updateStatus();
    }

    async function init(){
      statusLine.textContent = "Loading‚Ä¶";
      setLocked(true);

      loadState();

      const res = await fetch(MOVIES_URL, { cache: "no-store" });
      const data = await res.json();

      MOVIES = (data || [])
        .filter(x =>
          x &&
          (x.media_type || "").toString().toLowerCase() === "movie" &&
          x.title &&
          x.year
        )
        .map(x => ({
          title: x.title,
          year: Number(x.year),
          genres: x.genres || "",
          runtime_minutes: Number(x.runtime_minutes || 0),
          content_rating: x.content_rating || "",
          plot: x.plot || "",
          imdb_id: x.imdb_id || ""
        }));

      if (!MOVIES.length){
        statusLine.textContent = "No movies loaded.";
        setMessage("Your JSON loaded, but I didn‚Äôt find any items with media_type='movie'.", "bad");
        return;
      }

      ANSWER = MOVIES[dailyIndex(MOVIES.length)];
      FREEBIE = dailyFreebieKey();

      buildTitleIndex();
      showFreebie();

      // render existing guesses
      board.innerHTML = "";
      for (const g of STATE.guesses){
        const fb = compareGuess(g, ANSWER);
        renderRow(g, fb);
      }

      updateStatus();

      if (STATE.done){
        setLocked(true);
        const won = STATE.guesses.some(g => compareGuess(g, ANSWER).correct);
        showReveal(!!won); // ‚úÖ always reveal answer when finished
        setMessage(won ? "You already solved today‚Äôs Plexdle." : "Today‚Äôs Plexdle is already finished.", won ? "good" : "bad");
      } else {
        setLocked(false);
        guessInput.focus();
        setMessage("");
      }
    }

    guessBtn.addEventListener("click", handleGuess);
    guessInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleGuess();
    });

    resetBtn.addEventListener("click", resetToday);

    howBtn.addEventListener("click", () => {
      const showing = helpBox.style.display !== "none";
      helpBox.style.display = showing ? "none" : "block";
      howBtn.textContent = showing ? "How it works" : "Hide";
    });

    init().catch(err => {
      console.error(err);
      statusLine.textContent = "Load error.";
      setMessage("Couldn‚Äôt load the JSON. Check MOVIES_URL and CORS.", "bad");
    });
  </script>
</body>
</html>
